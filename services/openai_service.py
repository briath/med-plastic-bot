import asyncio
import logging
from typing import Optional, Dict, List, Tuple
import json
from openai import AsyncOpenAI
from config.settings import settings

logger = logging.getLogger(__name__)


class OpenAIService:
    """Сервис для работы с OpenAI GPT-4o-mini"""
    
    def __init__(self):
        self.api_key = settings.openai_api_key
        self.model = settings.openai_model
        self.base_url = getattr(settings, 'openai_base_url', 'https://api.openai.com/v1')
        self.client = AsyncOpenAI(
            api_key=self.api_key,
            base_url=self.base_url
        )
    
    async def generate_response(self, prompt: str, context: Dict = None) -> Optional[str]:
        """Генерирует ответ с помощью OpenAI GPT-4o-mini"""
        try:
            # Формируем полный промпт
            system_prompt, user_message = self._build_prompt(prompt, context)
            
            # Отправляем запрос к OpenAI
            response = await self._call_openai(system_prompt, user_message, context)
            
            if response:
                # Ограничиваем длину ответа (Telegram ограничение ~4096 символов)
                max_length = 3500  # Оставляем запас
                if len(response) > max_length:
                    response = response[:max_length] + "...\n\n(ответ сокращен для отображения в Telegram)"
                logger.info(f"OpenAI response generated successfully")
                return response
            else:
                logger.warning("Empty response from OpenAI")
                return None
                
        except Exception as e:
            logger.error(f"Error generating OpenAI response: {e}")
            return None
    
    def _build_prompt(self, user_message: str, context: Dict = None) -> Tuple[str, str]:
        """Строит полный промпт для OpenAI"""
        
        # Более короткий и гибкий системный промпт
        system_prompt = f"""Ты — Анна, виртуальный консультант клиники пластической хирургии "{settings.clinic_name}".

Твой стиль общения:
- Естественный, дружелюбный, как живой человек
- Отвечай прямо на вопрос без лишней воды
- Делись полезной информацией, не продавай
- Используй разговорный язык, избегай канцеляризмов
- Проявляй эмпатию, но не будь навязчивой

Важные правила:
1. НЕ предлагай консультацию в каждом ответе - только когда это действительно уместно
2. Если можешь дать полезную информацию по теме - дай ее!
3. Используй свои знания о пластической хирургии и эстетической медицине
4. Отвечай кратко (1-3 предложения), но по существу
5. Если вопрос сложный - дай развернутый ответ
6. Избегай шаблонных фраз "давайте обсудим на консультации"
7. МАКСИМАЛЬНАЯ ДЛИНА ОТВЕТА: 800 символов

Твоя цель - быть полезным консультантом, а не продавцом. Помоги человеку получить информацию.

Контакты (только если прямо спросат):
Телефон: {settings.clinic_phone}
Email: {settings.clinic_email}
Сайт: {getattr(settings, 'clinic_website', '')}
"""
        
        # Добавляем контекст об услуге только если релевантно
        service_context = ""
        if context and 'service' in context:
            service = context['service']
            # Добавляем только краткую информацию
            service_context = f"""
Краткая информация об услуге:
Название: {service.get('name', '')}
Цены: {service.get('price_range', '')}
Длительность: {service.get('duration', '')}
"""
        
        # Добавляем историю диалога для контекста
        chat_history = ""
        if context and 'history' in context:
            history = context['history'][-3:]  # Последние 3 сообщения
            for msg in history:
                role = "Клиент" if msg.get('role') == 'user' else "Анна"
                chat_history += f"{role}: {msg.get('text', '')}\n"
        
        # Формируем сообщение для пользователя
        full_user_message = f"""ВОПРОС КЛИЕНТА:
{user_message}

{service_context}

ИСТОРИЯ ДИАЛОГА:
{chat_history}

Отвечай естественно и по существу, как живой консультант.
"""
        
        return system_prompt, full_user_message
    
    async def _call_openai(self, system_prompt: str, user_message: str, context: Dict = None) -> Optional[str]:
        """Отправляет запрос к OpenAI API"""
        try:
            messages = [
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_message}
            ]
            
            response = await self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7,
                max_tokens=500,
                top_p=0.9,
                frequency_penalty=0.1,
                presence_penalty=0.1
            )
            
            if response.choices:
                return response.choices[0].message.content.strip()
            else:
                logger.error("No choices in OpenAI response")
                return None
                
        except Exception as e:
            logger.error(f"OpenAI API error: {e}")
            return None
    
    async def check_connection(self) -> bool:
        """Проверяет доступность OpenAI"""
        try:
            response = await self.client.models.list()
            return True
        except Exception as e:
            logger.error(f"OpenAI connection check failed: {e}")
            return False
    
    async def get_available_models(self) -> List[str]:
        """Получает список доступных моделей"""
        try:
            response = await self.client.models.list()
            return [model.id for model in response.data if 'gpt' in model.id]
        except Exception as e:
            logger.error(f"Failed to get OpenAI models: {e}")
            return []


class FallbackService:
    """Улучшенный сервис для ответов на часто задаваемые вопросы"""
    
    def __init__(self):
        self.faq_responses = {
            "привет": [
                "Здравствуйте! Готова ответить на ваши вопросы о пластической хирургии.",
                "Добрый день! Чем могу помочь?",
                "Привет! Что интересует в области эстетической медицины?"
            ],
            "увеличить грудь": [
                "Да, аугментация маммы - одна из самых популярных процедур. Используем импланты Motiva или Mentor, ставим под мышку или под железу. Реабилитация 1-2 недели. Хотите узнать о размерах?",
                "Конечно! Увеличение груди делают имплантами, срок службы 10-15 лет. Операция 1-2 часа, госпитализация 1 день. Интересуют детали?",
                "Да, мы делаем увеличение груди. Современные импланты очень безопасные, естественный вид. Восстановление быстрое. Что именно хотите узнать?"
            ],
            "уменьшить грудь": [
                "Да, редукционная маммопластика - популярная процедура. Обычно уменьшают на 1-2 размера, период восстановления 2-3 недели. Хотите узнать подробнее о технике?",
                "Конечно! Это называется редукционная маммопластика. Убирают излишки ткани и железы, делают подтяжку. Реабилитация относительно быстрая.",
                "Да, мы делаем редукцию груди. Среднее уменьшение на 1.5 размера, швы почти незаметны. Интересуют детали?"
            ],
            "пластика груди": [
                "Пластика груди включает несколько видов: увеличение, уменьшение, подтяжку. Импланты ставят обычно под мышку или под железу. Срок службы 10-15 лет.",
                "Основные виды - аугментация, редукция, мастопексия. Современные импланты очень безопасные, реабилитация 1-2 недели. Что именно интересует?",
                "Маммопластика - большая область. Увеличение делают имплантами, подтяжку - без них. Все под общим наркозом, госпитализация 1 день."
            ],
            "грудь": [
                "Пластика груди - наша специализация. Делаем увеличение, уменьшение, подтяжку. Используем современные импланты с пожизненной гарантией. Что именно интересует?",
                "Маммопластика включает разные процедуры. Увеличение имплантами, редукция, мастопексия. Все под общим наркозом, реабилитация 1-2 недели.",
                "Работаем с грудью более 10 лет. Используем импланты Motiva, Mentor. Естественные результаты, минимальные рубцы."
            ],
            "цена": [
                "Стоимость зависит от процедуры. Например, увеличение груди от 200 тыс, подтяжка от 150 тыс. Точную цену скажет врач на консультации.",
                "Цены варьируются. Базовые процедуры: липосакция от 80 тыс, ринопластика от 120 тыс. Есть рассрочка на 6 месяцев.",
                "У нас прозрачное ценообразование. Консультация бесплатная, на ней расскажут все стоимость и варианты."
            ],
            "риск": [
                "Как у любой операции, риски есть, но минимальны - около 1-2%. Используем современное оборудование и опытные хирургов.",
                "Осложнения редки благодаря нашим протоколам. Основные риски - стандартные для хирургии под наркозом.",
                "Безопасность приоритет. Уровень осложнений у нас ниже средних показателей по стране."
            ],
            "реабилитация": [
                "Зависит от процедуры. В среднем 1-2 недели ограничений, потом можно возвращаться к обычной жизни. Спорт через месяц.",
                "Период восстановления обычно 7-14 дней. Первые дни нужно отдыхать, потом постепенно возвращаться к активности.",
                "Реабилитация индивидуальна. Минимум - неделя отдыха, максимум - месяц ограничений. Все подробно объясним."
            ],
            "расскажи": [
                "С удовольствием! Что именно вас интересует? Расскажу об увеличении груди, ценах, реабилитации или рисках.",
                "Конечно! Могу подробно рассказать о любой процедуре. Что хотите узнать - технику, результаты, восстановление?",
                "Да, расскажу! Уточните, какая тема интересует - маммопластика, липосакция, ринопластика? Поделюсь всеми деталями."
            ],
            "все": [
                "Хорошо, расскажу по порядку! Увеличение груди: импланты под мышку, операция 1.5 часа, реабилитация 2 недели. Цена от 200 тыс. Риски минимальны. Что еще уточнить?",
                "Понятно! Основное: используем импланты Motiva, пожизненная гарантия, госпитализация 1 день, возвращение к работе через 10 дней. Конкретные вопросы есть?",
                "Отлично! Ключевые моменты: современное оборудование, опытные хирурги, естественные результаты. Консультация бесплатная, на ней все рассчитаем. Что интересует детально?"
            ]
        }
    
    async def get_fallback_response(self, message: str) -> Optional[str]:
        """Возвращает ответ на основе ключевых слов"""
        message_lower = message.lower()
        
        # Расширяем словарь синонимов для лучшего распознавания
        keyword_mapping = {
            "увеличить грудь": ["увеличить грудь", "аугментация", "увеличение груди", "сделать грудь больше", "импланты груди"],
            "уменьшить грудь": ["уменьшить грудь", "редукция", "уменьшение груди", "сделать грудь меньше"],
            "пластика груди": ["пластика груди", "маммопластика", "операция на груди", "хирургия груди"],
            "грудь": ["грудь", "бюст", "молочные железы"],
            "расскажи": ["расскажи", "расскажи пожалуйста", "расскажи подробно", "хочу узнать", "интересует"],
            "все": ["все", "все детали", "подробно", "расскажи все", "хочу все знать"],
            "цена": ["цена", "стоимость", "сколько стоит", "цены", "стоит"],
            "риск": ["риск", "риски", "опасно", "осложнения", "последствия"],
            "реабилитация": ["реабилитация", "восстановление", "после операции", "период восстановления", "сколько заживать"]
        }
        
        # Проверяем расширенные ключевые слова
        for main_keyword, variations in keyword_mapping.items():
            for variation in variations:
                if variation in message_lower:
                    import random
                    return random.choice(self.faq_responses[main_keyword])
        
        # Если нет конкретного ключевого слова, даем полезный ответ
        general_responses = [
            "Это интересный вопрос! Могу рассказать об общих принципах в пластической хирургии, если хотите.",
            "Хороший вопрос! В пластической хирургии много нюансов. Что именно вас интересует?",
            "Понимаю ваше любопытство! Эстетическая медицина развивается быстро. Могу поделиться актуальной информацией.",
            "Интересная тема! В нашей клинике мы используем современные методики. Хотите узнать подробнее?"
        ]
        
        import random
        return random.choice(general_responses)


# Глобальные экземпляры сервисов
openai_service = OpenAIService()
fallback_service = FallbackService()
